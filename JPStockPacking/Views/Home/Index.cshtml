@using JPStockPacking.Services.Helper
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["PageTitle"] = "หน้าแรก";
}

<style>
    .cursor-pointer {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .hover-shadow:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2) !important;
    }

    .info-box {
        min-height: 150px;
    }

    .info-box-text {
        font-size: 1.1rem;
        font-weight: bold;
    }

    .info-box-number {
        font-size: 0.9rem;
    }
</style>

<div class="wrapper">
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <h3>@ViewData["PageTitle"]</h3>
            </li>
        </ul>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item dropdown">
                <a class="nav-link" data-toggle="dropdown" href="#">
                    <i class="fas fa-user img-size-32 img-circle mr-2"></i>
                    <span>@User.GetUsername()?.ToLower()</span>
                    <input type="hidden" id="hddUserID" value="@User.GetUserId()" />
                </a>
            </li>
        </ul>
    </nav>
    <aside class="main-sidebar sidebar-dark-primary elevation-4 sidebar-mini sidebar-collapse">
        <a href="@Url.Action("Index", "Home")" class="brand-link">
            <img src="~/img/logo.png" alt="JP" class="brand-image img-circle elevation-3" style="background-color: #FFFFFF; width: 45px; height: 45px; border-radius: 50%;">
            <span class="brand-text font-weight-light">JP StockPacking</span>
        </a>
        <div class="sidebar d-flex flex-column">
            <nav class="mt-2 d-flex flex-column flex-grow-1">
                <ul class="nav nav-pills nav-sidebar flex-column flex-grow-1" data-widget="treeview" role="menu" data-accordion="false">
                    <li class="nav-header">MENU</li>
                    @if (User.HasClaim("Menu", "ReceiveManagement"))
                    {
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-action="@Url.Action("ReceiveManagement", "Home")">
                                <i class="nav-icon fas fa-receipt"></i>
                                <p>ใบรับสินค้า (ลงบิล)</p>
                            </a>
                        </li>
                    }

                    @if (User.HasClaim("Menu", "OrderManagement"))
                    {
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-action="@Url.Action("OrderManagement", "Home")">
                                <i class="nav-icon fas fa-boxes"></i>
                                <p>สต็อกแพ็คกิ้ง</p>
                            </a>
                        </li>
                    }

                    @if (User.HasClaim("Menu", "PackedManagement"))
                    {
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-action="@Url.Action("PackedManagement", "Home")">
                                <i class="nav-icon fas fa-truck-loading"></i>
                                <p>รายการส่งออก</p>
                            </a>
                        </li>
                    }

                    @if (User.HasClaim("Menu", "CheckQtyToPack"))
                    {
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-action="@Url.Action("CheckQtyToPack", "Home")">
                                <i class="nav-icon fas fa-clipboard-check"></i>
                                <p>แจ้งยอดบรรจุ</p>
                            </a>
                        </li>
                    }

                    @if (User.HasClaim("Menu", "Validation"))
                    {
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-action="@Url.Action("Validation", "Home")">
                                <i class="nav-icon fas fa-clipboard-check"></i>
                                <p>ตรวจสอบ</p>
                            </a>
                        </li>
                    }

                    @if (User.HasClaim("Menu", "UserManagement"))
                    {
                        <li class="nav-header">ADMINISTRATION</li>
                    }

                    @if (User.HasClaim("Menu", "UserManagement"))
                    {
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-action="@Url.Action("UserManagement", "Home")">
                                <i class="nav-icon fas fa-user-edit"></i>
                                <p>จัดการบัญชีผู้ใช้</p>
                            </a>
                        </li>
                    }

                    @if (User.HasClaim("Menu", "EmployeeManagement"))
                    {
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-action="@Url.Action("EmployeeManagement", "Home")">
                                <i class="nav-icon fas fa-users"></i>
                                <p>จัดการข้อมูลพนักงาน</p>
                            </a>
                        </li>
                    }

                    @if (User.HasClaim("Menu", "PermissionManagement"))
                    {
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-action="@Url.Action("PermissionManagement", "Home")">
                                <i class="nav-icon fas fa-user-shield"></i>
                                <p>จัดการสิทธิการเข้าถึง</p>
                            </a>
                        </li>
                    }

                    @if (User.HasClaim("Menu", "FormulaManagement"))
                    {
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-action="@Url.Action("FormulaManagement", "Home")">
                                <i class="nav-icon fas fa-solid fa-book-open"></i>
                                <p>จัดการสูตรคำนวน</p>
                            </a>
                        </li>
                    }

                    @if (User.HasClaim("Menu", "AppSettings"))
                    {
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-action="@Url.Action("AppSettings", "Home")">
                                <i class="nav-icon fas fa-cog"></i>
                                <p>ตั้งค่าทั่วไป</p>
                            </a>
                        </li>
                    }

                    <li class="nav-header"><hr class="border-top"></li>
                    <li class="nav-item mt-auto">
                        <a href="#" id="btnSignOut" class="nav-link">
                            <i class="nav-icon fas fa-sign-out-alt"></i>
                            <p>ออกจากระบบ</p>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <div class="content-wrapper">
        <section class="content">
            <div id="content-container">
                <h3 class="mb-2 text-center">MENU</h3>
                <div class="row justify-content-center">
                    @if (User.HasClaim("Menu", "ReceiveManagement"))
                    {
                        <div class="col-md-3 col-sm-6 col-12">
                            <a href="#" class="menu-box-link" data-action="@Url.Action("ReceiveManagement", "Home")" style="text-decoration: none;">
                                <div class="info-box bg-info cursor-pointer hover-shadow">
                                    <span class="info-box-icon"><i class="fas fa-receipt"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text" style="font-size:30px">ใบรับสินค้า (ลงบิล)</span>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }

                    @if (User.HasClaim("Menu", "OrderManagement"))
                    {
                        <div class="col-md-3 col-sm-6 col-12">
                            <a href="#" class="menu-box-link" data-action="@Url.Action("OrderManagement", "Home")" style="text-decoration: none;">
                                <div class="info-box bg-info cursor-pointer hover-shadow">
                                    <span class="info-box-icon"><i class="fas fa-boxes"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text" style="font-size:30px">สต็อกแพ็คกิ้ง</span>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }

                    @if (User.HasClaim("Menu", "PackedManagement"))
                    {
                        <div class="col-md-3 col-sm-6 col-12">
                            <a href="#" class="menu-box-link" data-action="@Url.Action("PackedManagement", "Home")" style="text-decoration: none;">
                                <div class="info-box bg-info cursor-pointer hover-shadow">
                                    <span class="info-box-icon"><i class="fas fa-truck-loading"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text" style="font-size:30px">รายการส่งออก</span>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }

                    @if (User.HasClaim("Menu", "CheckQtyToPack"))
                    {
                        <div class="col-md-3 col-sm-6 col-12">
                            <a href="#" class="menu-box-link" data-action="@Url.Action("CheckQtyToPack", "Home")" style="text-decoration: none;">
                                <div class="info-box bg-info cursor-pointer hover-shadow">
                                    <span class="info-box-icon"><i class="fas fa-clipboard-check"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text" style="font-size:30px">แจ้งยอดบรรจุ</span>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                </div>

                @if (User.HasClaim("Menu", "Validation"))
                {
                    <div class="row justify-content-center mt-3">
                        <div class="col-md-3 col-sm-6 col-12">
                            <a href="#" class="menu-box-link" data-action="@Url.Action("Validation", "Home")" style="text-decoration: none;">
                                <div class="info-box bg-info cursor-pointer hover-shadow">
                                    <span class="info-box-icon"><i class="fas fa-clipboard-check"></i></span>
                                    <div class="info-box-content">
                                        <span class="info-box-text" style="font-size:30px">ตรวจสอบ</span>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                }

                @if (User.HasClaim("Menu", "UserManagement") || User.HasClaim("Menu", "FormulaManagement") || User.HasClaim("Menu", "AppSettings"))
                {
                    <h3 class="mt-5 mb-2 text-center">ADMINISTRATION</h3>
                    <div class="row justify-content-center">
                        @if (User.HasClaim("Menu", "UserManagement"))
                        {
                            <div class="col-md-3 col-sm-6 col-12">
                                <a href="#" class="menu-box-link" data-action="@Url.Action("UserManagement", "Home")" style="text-decoration: none;">
                                    <div class="info-box bg-dark cursor-pointer hover-shadow">
                                        <span class="info-box-icon"><i class="fas fa-user-edit"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text" style="font-size:30px">จัดการผู้ใช้</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        }

                        @if (User.HasClaim("Menu", "EmployeeManagement"))
                        {
                            <div class="col-md-3 col-sm-6 col-12">
                                <a href="#" class="menu-box-link" data-action="@Url.Action("EmployeeManagement", "Home")" style="text-decoration: none;">
                                    <div class="info-box bg-dark cursor-pointer hover-shadow">
                                        <span class="info-box-icon"><i class="fas fa-users"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text" style="font-size:30px">จัดการข้อมูลพนักงาน</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        }

                        @if (User.HasClaim("Menu", "PermissionManagement"))
                        {
                            <div class="col-md-3 col-sm-6 col-12">
                                <a href="#" class="menu-box-link" data-action="@Url.Action("PermissionManagement", "Home")" style="text-decoration: none;">
                                    <div class="info-box bg-dark cursor-pointer hover-shadow">
                                        <span class="info-box-icon"><i class="fas fa-user-shield"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text" style="font-size:30px">จัดการสิทธิการเข้าถึง</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        }

                        @if (User.HasClaim("Menu", "FormulaManagement"))
                        {
                            <div class="col-md-3 col-sm-6 col-12">
                                <a href="#" class="menu-box-link" data-action="@Url.Action("FormulaManagement", "Home")" style="text-decoration: none;">
                                    <div class="info-box bg-dark cursor-pointer hover-shadow">
                                        <span class="info-box-icon"><i class="fas fa-book-open"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text" style="font-size:30px">สูตรคำนวน</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        }

                        @if (User.HasClaim("Menu", "AppSettings"))
                        {
                            <div class="col-md-3 col-sm-6 col-12">
                                <a href="#" class="menu-box-link" data-action="@Url.Action("AppSettings", "Home")" style="text-decoration: none;">
                                    <div class="info-box bg-dark cursor-pointer hover-shadow">
                                        <span class="info-box-icon"><i class="fas fa-cog"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text" style="font-size:30px">ตั้งค่าทั่วไป</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        }
                    </div>
                }
            </div>
        </section>
    </div>

    <footer class="main-footer">
        <div class="float-right d-none d-block pr-3">
            <b>App Version</b> @ViewBag.AppVersion
        </div>
        <p></p>
    </footer>

    <aside class="control-sidebar control-sidebar-dark"></aside>
</div>

@section Scripts {
    <script>
        window.urlGetReceived = '@Url.Action("GetReceived", "Home")';
        window.urlOrderMarkAsRead = '@Url.Action("OrderMarkAsRead", "Home")';
        window.urlGetOrder = '@Url.Action("GetOrder", "Home")';
        window.urlUpdateLotItems = '@Url.Action("UpdateLotItems", "Home")';
        window.urlGetReceivedToAssign = '@Url.Action("GetReceivedToAssign", "Home")';
        window.urlGetTableMember = '@Url.Action("GetTableMember", "Home")';
        window.urlAssignToTable = '@Url.Action("AssignToTable", "Home")';
        window.urlGetTableToReturn = '@Url.Action("GetTableToReturn", "Home")';
        window.urlGetRecievedToReturn = '@Url.Action("GetRecievedToReturn", "Home")';
        window.urlReturnAssignment = '@Url.Action("ReturnAssignment", "Home")';
        window.urlImportReceiveNo = '@Url.Action("ImportReceiveNo", "Home")';
        window.urlUpdateLotByRevNoItems = '@Url.Action("UpdateLotByRevNoItems", "Home")';
        window.urlGetOrderToSendQty = '@Url.Action("GetOrderToSendQty", "Home")';
        window.urlDefineToPack = '@Url.Action("DefineToPack", "Home")';
        window.urlGetTableMemberByAssignedID = '@Url.Action("GetTableMemberByAssignedID", "Home")';
        window.urlGetImage = '@Url.Action("GetImage", "Home")';
        window.urlSendQtyToPackReport = '@Url.Action("SendQtyToPackReport", "Home")';
        window.urlGetReceiveRow = '@Url.Action("GetReceiveRow", "Home")';
        window.urlCheckUser = '@Url.Action("CheckUser", "Home")';
        window.urlGetReceiveList = '@Url.Action("GetReceiveList", "Home")';
        window.urlAddNewBreakDescription = '@Url.Action("AddNewBreakDescription", "Home")';
        window.urlLostReport = '@Url.Action("LostReport", "Home")';
        window.urlBreakReport = '@Url.Action("BreakReport", "Home")';
        window.urlGetCustomLot = '@Url.Action("GetCustomLot", "Home")';
        window.urlGetUser = '@Url.Action("GetUser", "Home")';
        window.urlAddNewUser = '@Url.Action("AddNewUser", "Home")';
        window.urlAvailableEmployee = '@Url.Action("AvailableEmployee", "Home")';
        window.urlEditUser = '@Url.Action("EditUser", "Home")';
        window.urlToggleUserStatus = '@Url.Action("ToggleUserStatus", "Home")';
        window.urlGetLost = '@Url.Action("GetLost", "Home")';
        window.urlAddLost = '@Url.Action("AddLost", "Home")';
        window.urlGetBreak = '@Url.Action("GetBreak", "Home")';
        window.urlAddBreak = '@Url.Action("AddBreak", "Home")';
        window.urlGetOrderToStore = '@Url.Action("GetOrderToStore", "Home")';
        window.urlSendToStore = '@Url.Action("SendToStore", "Home")';
        window.urlConfirmToSendStore = '@Url.Action("ConfirmToSendStore", "Home")';
        window.urlUpdateAppSettings = '@Url.Action("UpdateAppSettings", "Home")';
        window.urlPrintSendToAllReport = '@Url.Action("PrintSendToAllReport", "Home")';
        window.urlGetComparedInvoice = '@Url.Action("GetComparedInvoice", "Home")';
        window.urlGetUnallocatedQuentityToStore = '@Url.Action("GetUnallocatedQuentityToStore", "Home")';
        window.urlGetFormula = '@Url.Action("GetFormula", "Home")';
        window.urlAddNewFormula = '@Url.Action("AddNewFormula", "Home")';
        window.urlEditFormula = '@Url.Action("EditFormula", "Home")';
        window.urlToggleFormulaStatus = '@Url.Action("ToggleFormulaStatus", "Home")';
        window.urlGetUserPermission = '@Url.Action("GetUserPermission", "Home")';
        window.urlUpdateUserPermission = '@Url.Action("UpdateUserPermission", "Home")';
        window.urlGetEmployeeByID = '@Url.Action("GetEmployeeByID", "Home")';
    </script>

    <script src="~/js/OrderManagement.js" asp-append-version="true"></script>
    <script src="~/js/CheckQtyToPack.js" asp-append-version="true"></script>
    <script src="~/js/ReceiveManagement.js" asp-append-version="true"></script>
    <script src="~/js/UserManagement.js" asp-append-version="true"></script>
    <script src="~/js/PackedManagement.js" asp-append-version="true"></script>
    <script src="~/js/AppSettings.js" asp-append-version="true"></script>
    <script src="~/js/Audit.js" asp-append-version="true"></script>
    <script src="~/js/FormulaManagement.js" asp-append-version="true"></script>
    <script src="~/js/PermissionManagement.js" asp-append-version="true"></script>
    <script src="~/js/EmploeeManagement.js" asp-append-version="true"></script>

    <script>
        $(document).ready(function() {
            $('.nav-sidebar .nav-link').on('click', function(e) {
                e.preventDefault();
                var actionUrl = $(this).data('action');

                if (actionUrl) {
                    $('.nav-sidebar .nav-link').removeClass('active');
                    $(this).addClass('active');

                    $('#content-container').html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-3x"></i><p class="mt-3">Loading...</p></div>');

                    $.get(actionUrl, function(data) {
                        $('#content-container').html(data);
                        var title = $('#content-container').find('#page-title').data('title');
                        if (title) {
                            $('.navbar-nav h3').text(title);
                        }
                    }).fail(function() {
                        $('#content-container').html('<div class="alert alert-danger">Error loading content. Please try again.</div>');
                    });
                }
            });

            $('.menu-box-link').on('click', function(e) {
                e.preventDefault();
                var actionUrl = $(this).data('action');

                if (actionUrl) {
                    // ลบ active class จาก sidebar
                    $('.nav-sidebar .nav-link').removeClass('active');

                    // หา sidebar link ที่ตรงกับ actionUrl และเพิ่ม active class
                    $('.nav-sidebar .nav-link').each(function() {
                        if ($(this).data('action') === actionUrl) {
                            $(this).addClass('active');
                            return false;
                        }
                    });

                    // แสดง loading
                    $('#content-container').html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-3x"></i><p class="mt-3">Loading...</p></div>');

                    // โหลดเนื้อหาแบบ AJAX
                    $.get(actionUrl, function(data) {
                        $('#content-container').html(data);

                        // อัปเดตชื่อหน้าใน navbar
                        var title = $('#content-container').find('#page-title').data('title');
                        if (title) {
                            $('.navbar-nav h3').text(title);
                        }

                        // เลื่อนขึ้นด้านบน
                        window.scrollTo(0, 0);
                    }).fail(function() {
                        $('#content-container').html('<div class="alert alert-danger m-3">เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาลองใหม่อีกครั้ง</div>');
                    });
                }
            });

            $('#btnSignOut').on('click', function(e) {
                e.preventDefault();
                $('#loadingIndicator').show();
                $.post('@Url.Action("Logout", "Auth")', function(res) {
                    window.location.href = res.redirectUrl;
                });
            });
        });
    </script>
}