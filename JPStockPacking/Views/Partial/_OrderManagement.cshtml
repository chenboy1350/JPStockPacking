@model JPStockPacking.Models.ScheduleListModel

@{
    var today = DateTime.Now.Date;
}

<div class="container-fluid">
    <div class="row">
        <div class="card">
            <div class="card-body">
                <div class="accordion" id="accordionFilter">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFilter">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilter" aria-expanded="false" aria-controls="collapseFilter">
                                <strong>Find By</strong>
                            </button>
                        </h2>
                        <div id="collapseFilter" class="accordion-collapse collapse" aria-labelledby="headingFilter" data-bs-parent="#accordionFilter">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>OrderNo</label>
                                            <input type="text" id="txtImportOrderNo" class="form-control">
                                            <button class="btn btn-primary mt-2" id="btnImportOrder">นำเข้าออเดอร์</button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>ReceivedNo</label>
                                            <input type="text" id="txtImportReceivedNo" class="form-control">
                                            <button class="btn btn-primary mt-2" id="btnImportReceivedNo">นำเข้าใบรับ</button>
                                            <button class="btn btn-primary mt-2" id="btnViewReceivedNo">ดูรายการใบรับ</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>OrderNo</label>
                                            <input type="text" id="txtOrderNo" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>CustCode</label>
                                            <input type="text" id="txtCustCode" class="form-control">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>From Date</label>
                                            <input type="date" id="fromDate" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>To Date</label>
                                            <input type="date" id="toDate" class="form-control">
                                        </div>
                                    </div>
                                </div>
@*                                 <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="groupMode"></label>
                                            <input type="radio" name="groupMode" value="0" checked /> Day
                                            <label for="groupMode2"></label>
                                            <input type="radio" id="groupMode2" name="groupMode" value="1" /> Week
                                        </div>
                                    </div>
                                </div> *@
                                <button class="btn btn-primary" onclick="ClearFindBy()">Clear</button>
                                <button class="btn btn-primary" onclick="fetchOrdersByDateRange()">Find</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Day List</h3>
            </div>
            <div class="card-body">
                <div class="accordion" id="accordionOrder">
                    @foreach (var order in Model.Days)
                    {
                        foreach (var item in order.Orders)
                        {
                            <div class="accordion-item mt-2" data-order-no="@item.OrderNo">
                                <h2 class="accordion-header" id="heading@(item.OrderNo)">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse@(item.OrderNo)" aria-expanded="false" aria-controls="collapse@(item.OrderNo)">
                                        <div class="d-flex justify-content-between w-100">
                                            <div class="col-md-3">
                                                <strong>
                                                    @item.CustCode/@item.OrderNo
                                                    @Html.Raw(item.IsReceivedLate == true ? "<i class='fas fa-fire-alt' style='color: #e85700; '></i>" : "")
                                                    @Html.Raw(item.IsPackingLate == true ? "<i class='fas fa-fire-alt' style='color: red; '></i>" : "")
                                                    @Html.Raw(item.IsNew == true ? "<span class='badge bg-danger new'>ใหม่</span>" : "")
                                                    @Html.Raw(item.IsUpdate == true ? "<span class='badge bg-warning'>มีการนำส่ง</span>" : "")
                                                </strong>
                                            </div>
                                            <div class="col-md-3">
                                                <i class="fas fa-clipboard-check"></i> @item.OrderDate
                                                <i class="fas fa-box-open"></i> @item.SeldDate1
                                            </div>
                                            <div class="col-md-2">
                                                <i class="fas fa-business-time"></i> @item.StartDateTH
                                            </div>
                                            <div class="col-md-1">
                                                <i class="fas fa-boxes"></i> @item.CompleteLot/@item.TotalLot
                                            </div>
                                            <div class="col-md-1">
                                                <i class="fas fa-boxes"></i> @item.SumTtQty
                                            </div>
                                            <div class="col-md-1">
                                                <i class="fas fa-clipboard-check"></i> @item.PackDaysRemain วัน
                                            </div>
                                            <div class="col-md-1">
                                                <i class="fas fa-box-open"></i> @item.ExportDaysRemain วัน
                                            </div>
                                            <div></div>
                                        </div>
                                    </button>
                                </h2>
                                <div id="collapse@(item.OrderNo)" class="accordion-collapse collapse" aria-labelledby="heading@(item.OrderNo)" data-bs-parent="#accordionOrder">
                                    <div class="accordion-body table-responsive" style="overflow: auto;">
                                        <table class="table table-striped projects">
                                            <thead>
                                                <tr>
                                                    <th style="width: 1%">
                                                        #
                                                    </th>
                                                    <th style="width: 20%">
                                                        หมายเลขล็อต
                                                    </th>
                                                    <th style="width: 10%">
                                                        ลำดับที่
                                                    </th>
                                                    <th style="width: 25%">
                                                        การมอบหมาย
                                                    </th>
                                                    <th>
                                                        ความคืบหน้า
                                                    </th>
                                                    <th style="width: 8%" class="text-center">
                                                        สถานะ
                                                    </th>
                                                    <th style="width: 20%">
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var lot in item.CustomLot)
                                                {
                                                    <tr data-lot-no="@lot.LotNo">
                                                        <td>
                                                            #
                                                        </td>
                                                        <td>
                                                            <a>
                                                                <strong>@lot.LotNo</strong>
                                                                @Html.Raw((item.IsReceivedLate == true && lot.IsPacked != true) ? "<i class='fas fa-fire-alt' style='color: #e85700; '></i>" : "")
                                                                @Html.Raw((item.IsPackingLate == true && lot.IsPacked != true) ? "<i class='fas fa-fire-alt' style='color: red; '></i>" : "")
                                                                @Html.Raw(lot.IsUpdate ? "<span class='badge bg-warning update'>มีการนำส่ง</span>" : "")
                                                            </a>
                                                            <br />
                                                            <small>
                                                                ปรับปรุงล่าสุด : @(lot.UpdateDate ?? "N/A")
                                                            </small>
                                                        </td>
                                                        <td>
                                                            @lot.ListNo
                                                        </td>
                                                        <td>
                                                            <a>
                                                                @lot.AssignTo
                                                            </a>
                                                        </td>
                                                        <td class="project_progress">
                                                            <div class="progress progress-sm">
                                                                @{
                                                                    var percent = lot.TtQty > 0 ? (lot.ReceivedQty * 100 / lot.TtQty) : 0;
                                                                    var progressHtml = "";

                                                                    if (!lot.IsAllReceived)
                                                                    {
                                                                        // ยังรับของไม่ครบ
                                                                        progressHtml = $"<div class='progress-bar bg-orange' role='progressbar' aria-valuenow='{percent}' aria-valuemin='0' aria-valuemax='100' style='width: {percent}% '></div>";
                                                                    }
                                                                    else if (lot.IsAllReceived && !lot.IsPacking)
                                                                    {
                                                                        // รับของครบแล้ว แต่ยังไม่เริ่มบรรจุ
                                                                        progressHtml = $"<div class='progress-bar bg-light-orange' role='progressbar' aria-valuenow='{percent}' aria-valuemin='0' aria-valuemax='100' style='width: {percent}% '></div>";
                                                                    }
                                                                    else if (lot.IsPacking && !lot.IsAllPacking)
                                                                    {
                                                                        // กำลังบรรจุ
                                                                        var packPercent = lot.TtQty > 0 ? (lot.PackedQty * 100 / lot.TtQty) : 0;
                                                                        progressHtml = $"<div class='progress-bar bg-green' role='progressbar' aria-valuenow='{packPercent}' aria-valuemin='0' aria-valuemax='100' style='width: {packPercent}% '></div>";
                                                                    }
                                                                    else if (lot.IsAllPacking)
                                                                    {
                                                                        // บรรจุครบแล้ว
                                                                        progressHtml = $"<div class='progress-bar bg-info' role='progressbar' aria-valuenow='100' aria-valuemin='0' aria-valuemax='100' style='width: 100% '></div>";
                                                                    }
                                                                }
                                                                @Html.Raw(progressHtml)
                                                            </div>
                                                            <small>
                                                                @{
                                                                    string progressText = "";

                                                                    if (!lot.IsAllReceived)
                                                                    {
                                                                        progressText = $"{lot.ReceivedQty} / {lot.TtQty}";
                                                                    }
                                                                    else if (lot.IsAllReceived && !lot.IsPacking)
                                                                    {
                                                                        progressText = $"{lot.ReceivedQty} / {lot.TtQty} ";
                                                                    }
                                                                    else if (lot.IsPacking && !lot.IsAllPacking)
                                                                    {
                                                                        var packPercent = lot.TtQty > 0 ? (lot.PackedQty * 100 / lot.TtQty) : 0;
                                                                        progressText = $"{lot.PackedQty} / {lot.TtQty}";
                                                                    }
                                                                    else if (lot.IsAllPacking)
                                                                    {
                                                                        progressText = $"{lot.TtQty} / {lot.TtQty}";
                                                                    }
                                                                }

                                                                @progressText
                                                            </small>
                                                        </td>
                                                        <td class="project-state">
                                                            @if (lot.ReceivedQty < lot.TtQty)
                                                            {
                                                                <span class="badge badge-orange">รอนำส่ง</span>
                                                            }

                                                            @if (lot.TtQty > 0 && lot.ReceivedQty >= lot.TtQty)
                                                            {
                                                                <span class="badge badge-orange">รับครบแล้ว</span>
                                                            }

                                                            @if (lot.IsAllReceived && !lot.IsPacking)
                                                            {
                                                                <span class="badge badge-light-orange">รอจ่ายงาน</span>
                                                            }

                                                            @if (lot.IsPacking && !lot.IsAllPacking)
                                                            {
                                                                <span class="badge badge-warning">กำลังบรรจุ</span>
                                                            }

                                                            @if (lot.IsAllPacking)
                                                            {
                                                                <span class="badge badge-info">บรรจุครบแล้ว</span>
                                                            }
                                                        </td>
                                                        <td class="project-actions text-right">
                                                            @Html.Raw(lot.IsUpdate ? string.Format("<button class='btn btn-warning btn-sm' onclick='showModalUpdateLot({0})'><i class='fas fa-folder-plus'></i> ตรวจสอบ</button>", lot.LotNo) : "")
                                                            @Html.Raw(((item.IsReceivedLate || lot.IsAllReceived) && !lot.IsAllPacking && lot.TtQty != 0) ? string.Format("<button class='btn btn-primary btn-sm' onclick='showModalAssign({0})'><i class='fas fa-folder'></i> จ่ายงาน</button>", lot.LotNo) : "")
                                                            @Html.Raw((lot.IsPacking && !lot.IsAllPacking) ? string.Format("<button class='btn btn-danger btn-sm' onclick='showModalReturn({0})'><i class='fas fa-folder'></i> รับคืน</button>", lot.LotNo) : "")
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-update">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="txtTitleUpdate"><i class='fas fa-folder-plus'></i> รายการนำเข้าของล็อต : [lotNo]</h4>
                <input type="hidden" id="hddUpdateLotNo" value="" />
                <button type="button" class="close" onclick="CloseModal()" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card-body table-responsive p-0">
                    <table class="table table-head-fixed text-nowrap">
                        <thead>
                            <tr>
                                <th>เลขที่ใบรับ</th>
                                <th>หมายเลขล็อต</th>
                                <th>เลขที่คำสั่งซื้อ</th>
                                <th>ลำดับที่</th>
                                <th>เลขที่งาน</th>
                                <th>รหัสสินค้า</th>
                                <th>จำนวน</th>
                                <th>น้ำหนักรวม(g)</th>
                                <th>เลือก</th>
                            </tr>
                        </thead>
                        <tbody id="tbl-received-body">
                            <tr>
                                <td>[ReceivedNo]</td>
                                <td>[LotNo]</td>
                                <td>[OrderNo]</td>
                                <td>[ListNo]</td>
                                <td>[Barcode]</td>
                                <td>[Article]</td>
                                <td>[Ttqty]</td>
                                <td>[Ttwg]</td>
                                <td>
                                    <div class="icheck-primary d-inline">
                                        <input type="checkbox" id="checkboxReceivedNo">
                                        <label for="checkboxReceivedNo">
                                        </label>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-warning" id="btnUpdateLot">รับเข้า</button>
                <button type="button" class="btn btn-default" onclick="CloseModal()">ปิด</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modal-assign">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="txtTitleAssign">รายการมอบหมายงาน : [LotNo]</h4>
                <input type="hidden" id="hddAssignLotNo" value="" />
                <button type="button" class="close" onclick="CloseModal()" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card card-default" style="overflow: auto;">
                    <div class="card-header">
                        <h3 class="card-title">เลือกใบนำส่ง</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="display: block;">
                        <div class="row">
                            <table class="table table-head-fixed text-nowrap">
                                <thead>
                                    <tr>
                                        <th>เลขที่ใบรับ</th>
                                        <th>หมายเลขล็อต</th>
                                        <th>เลขที่คำสั่งซื้อ</th>
                                        <th>ลำดับที่</th>
                                        <th>เลขที่งาน</th>
                                        <th>รหัสสินค้า</th>
                                        <th>จำนวน</th>
                                        <th>น้ำหนักรวม(g)</th>
                                        <th>เลือก</th>
                                    </tr>
                                </thead>
                                <tbody id="tbl-receivedToAssign-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card card-default" style="overflow: auto;">
                    <div class="card-header">
                        <h3 class="card-title">เลือกโต๊ะ และสมาชิก</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="display: block;">
                        <div class="row">
                            <select class="custom-select rounded-0" id="cbxTables">
                                <option value="" selected>- เลือกโต๊ะ -</option>
                                @foreach (var table in ViewBag.Tables)
                                {
                                    <option value="@table.Id">@table.Name</option>
                                }
                            </select>
                            <table class="table table-head-fixed text-nowrap">
                                <thead>
                                    <tr>
                                        <th>ชื่อ</th>
                                        <th>เลือก</th>
                                    </tr>
                                </thead>
                                <tbody id="tblMembers">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-primary" id="btnConfirmAssign">มอบหมาย</button>
                <button type="button" class="btn btn-default" onclick="CloseModal()">ปิด</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-return">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="txtTitleReturn">รายการรับงานคืน : 2500010702 From Table 1 (Jun)</h4>
                <button type="button" class="close" onclick="CloseModal()" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card card-default" style="overflow: auto;">
                    <div class="card-header">
                        <h3 class="card-title"></h3>
                        <input type="hidden" id="hddReturnLotNo" />
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="display: block;">
                        <div class="row">
                            <label for="cbxTableToReturn">เลือกโต๊ะที่มีการมอบหมาย</label>
                            <select class="custom-select rounded-0" id="cbxTableToReturn">
                                <option value="" selected>- เลือกโต๊ะ -</option>
                            </select>
                            <table class="table table-head-fixed text-nowrap">
                                <thead>
                                    <tr>
                                        <th>เลขที่ใบรับ</th>
                                        <th>หมายเลขล็อต</th>
                                        <th>เลขที่คำสั่งซื้อ</th>
                                        <th>ลำดับที่</th>
                                        <th>เลขที่งาน</th>
                                        <th>รหัสสินค้า</th>
                                        <th>จำนวน</th>
                                        <th>น้ำหนักรวม(g)</th>
                                        <th>เลือก</th>
                                    </tr>
                                </thead>
                                <tbody id="tbl-receivedReturn-body">
                                </tbody>
                            </table>
                            <div class="row">
                                <div class="form-group">
                                    <div class="col-3">
                                        <label>จำนวนจากใบรับที่เลือก</label>
                                        <input type="number" min="0" max="999999" id="txtReurnQty" class="form-control" readonly>
                                    </div>
                                    <div class="col-3 mt-2">
                                        <label>จำนวนที่ศูนย์หาย</label>
                                        <input type="number" min="0" max="999999" id="txtLostQty" class="form-control" placeholder="Enter Lost">
                                    </div>
                                    <div class="col-3 mt-2">
                                        <label>ขำนวนที่ชำรุด</label>
                                        <input type="number" min="0" max="999999" id="txtBreakQty" class="form-control" placeholder="Enter Break">
                                    </div>
                                    <div class="col-3 mt-2">
                                        <label>ส่งคืนรวมทั้งสิ้น</label>
                                        <input type="number" min="0" max="999999" id="txtTotalReurnQty" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" id="btnConfirmReturn" class="btn btn-danger">ยืนยัน</button>
                <button type="button" id="btnLostAndRepair" class="btn btn-danger" style="display:none;">ส่งซ่อมหรือสูญหาย</button>
                <button type="button" class="btn btn-default" onclick="CloseModal()">ปิด</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-update-all">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="txtTitleUpdateAll">Rev No : </h4>
                <input type="hidden" id="hddUpdateReceiveNo" value="" />
                <button type="button" class="close" onclick="CloseModal()" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card-body" style="display: block;">
                    <div class="row">
                        <table class="table table-head-fixed text-nowrap" style="overflow: auto;">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>หมายเลขล็อต</th>
                                    <th>เลขที่คำสั่งซื้อ</th>
                                    <th>ลำดับที่</th>
                                    <th>เลขที่งาน</th>
                                    <th>รหัสสินค้า</th>
                                    <th>จำนวน</th>
                                    <th>น้ำหนักรวม(g)</th>
                                    <th>เลือก</th>
                                </tr>
                            </thead>
                            <tbody id="tbl-all-received">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <button type="button" class="btn btn-warning" id="btnAllUpdateLot">รับเข้า</button>
                <button type="button" class="btn btn-default" onclick="CloseModal()">ปิด</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-Sendto">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Send Lot : 2500010703 To</h4>
                <button type="button" class="close" onclick="CloseModal()" aria-label="Close">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card card-default">
                    <div class="card-header">
                        <h3 class="card-title">Return Detail</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="display: block;">
                        <div class="row">
                            <div class="form-group">
                                <div class="col-3">
                                    <label>Send To Store</label>
                                    <input type="text" class="form-control" placeholder="Enter ...">
                                </div>
                                <div class="col-3 mt-2">
                                    <label>Send to Refine</label>
                                    <input type="text" class="form-control" placeholder="Enter ...">
                                </div>
                                <div class="col-3 mt-2">
                                    <label>Center Amount</label>
                                    <input type="text" class="form-control" placeholder="Enter ...">
                                </div>
                                <div class="col-3 mt-2">
                                    <label>Total</label>
                                    <input type="text" class="form-control" placeholder="">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" onclick="CloseModal()">Close</button>
                <button type="button" class="btn btn-info">Send</button>
            </div>
        </div>
    </div>
</div>

<div id="page-title" data-title="จัดการคำสั่งซื้อ"></div>